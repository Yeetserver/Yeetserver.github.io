<!DOCTYPE html>
<html lang="de">
<head>
    <!-- Scripts & CSS -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons"/>
    <link rel="stylesheet" href="/src/dependencies/appearance.css">
    <script src="/src/dependencies/functions.js"></script>
    <script src="/src/dependencies/cookies.js"></script>
    <script defer src="/src/dependencies/appearance.js"></script>
    <!-- Titlebar -->
    <link rel="shortcut icon" type="image/x-icon" href="/assets/images/index-icon.png"/>
    <title>Yeetserver - MP</title>
    <!-- Open Graph protocol -->
    <meta property="og:type" content="Website">
    <meta property="og:title" content="Yeetserver Website">
    <meta property="og:description" content="Die Offizielle Website des Yeetserver's"/>
    <meta property="og:image" content="https://yeetserver.github.io/assets/images/index-icon.png"/>
    <!-- Website specific contents -->
</head>
<body onload="startup()">
<div class="buttons">
<input id="saveButton" style="height:40px; width:40px" type="image" src="https://cdn-icons-png.flaticon.com/128/439/439894.png"/>
<input id="loadButton" style="height:40px; width:40px" type="image" src="https://cdn-icons-png.flaticon.com/128/3121/3121602.png"/>
<input id="clearButton" style="height:40px; width:40px" type="image" src="https://cdn-icons-png.flaticon.com/128/484/484560.png"/>
<input id="colorChooser" style="height:40px; width:40px" type="color" src="https://cdn-icons-png.flaticon.com/128/3214/3214398.png"/>
</div>
<style>
canvas{
  position:absolute;
  left:0;
  top:0;
  z-index:-1;
}
.buttons {
  position:absolute;
  left:10px;
  top:10px;
}
</style>

<script type="module">
function getCookie(cname) {
    let name = cname + '=';
    let decodedCookie = decodeURIComponent(document.cookie);
    let ca = decodedCookie.split(';');
    for (let i = 0; i <ca.length; i++) {
    let c = ca[i];
    while (c.charAt(0) == ' ') {
      c = c.substring(1);
    }
    if (c.indexOf(name) == 0) {
      return c.substring(name.length, c.length);
    }}
    return '';
};

// connect to database
import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.12.1/firebase-app.js';
import { getAuth } from 'https://www.gstatic.com/firebasejs/9.12.1/firebase-auth.js';
import { getDatabase, ref, onValue, set, child, get } from 'https://www.gstatic.com/firebasejs/9.12.1/firebase-database.js';

try {const firebaseConfig = JSON.parse(getCookie('DBAKEYVAL'))}
catch {window.location.replace(`https://yeetserver.github.io/settings/login?${document.URL}#Du+bist+nicht+angemeldet`)}

const app = initializeApp(firebaseConfig);
export const auth = getAuth(app);
const db = getDatabase();
const reference = ref(db, 'game/canvas');

// add listeners

window.addEventListener('resize', resize);
document.addEventListener('mousemove', draw);
document.addEventListener('mousedown', setPosition);
document.addEventListener('mouseenter', setPosition);
document.getElementById('clearButton').addEventListener('click', clearCanvas);
document.getElementById('saveButton').addEventListener('click', save);
document.getElementById('loadButton').addEventListener('click', load);
document.getElementById('colorChooser').addEventListener('change', changeColor);

// general functions

function changeColor () {
  console.log(`changed color from ${ctx.strokeStyle} to ${document.getElementById('colorChooser').value}`);
  ctx.strokeStyle = document.getElementById('colorChooser').value
}

function clearCanvas() {
  ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height)
}

function save () {
  var data = canvas.toDataURL();
  set(ref(db, 'game'), {
  canvas: data
  })
}

function load () {
  clearCanvas()
  onValue(reference, (snapshot) => {
  var img = new Image;
  img.onload = function(){
    ctx.drawImage(img,0,0); // Or at whatever offset you like
  };
  img.src = snapshot.val().canvas
})};

// create canvas element and append it to document body
var canvas = document.createElement('canvas');
document.body.appendChild(canvas);

// some hotfixes... ( ≖_≖)
document.body.style.margin = 0;
canvas.style.position = 'fixed';

// get canvas 2D context and set him correct size
var ctx = canvas.getContext('2d');
resize();

// style settings
ctx.lineWidth = 5;
ctx.lineCap = 'round';
ctx.strokeStyle = '#00aaff';
document.getElementById('colorChooser').value = '#00aaff'

// last known position
var pos = { x: 0, y: 0 };

// new position from mouse event
function setPosition(e) {
  pos.x = e.clientX;
  pos.y = e.clientY;
}

// resize canvas
function resize() {
  ctx.canvas.width = window.innerWidth;
  ctx.canvas.height = window.innerHeight;
}

function draw(e) {
  // mouse left button must be pressed
  if (e.buttons !== 1) return;

  ctx.beginPath(); // begin

  ctx.moveTo(pos.x, pos.y); // from
  setPosition(e);
  ctx.lineTo(pos.x, pos.y); // to

  ctx.stroke(); // draw it!
}

// database

const referenceE = ref(db, 'game');
try{onValue(referenceE, (snapshot) => {
  const enabled = snapshot.val().enabled;
  if (!enabled) {window.location.replace(`https://yeetserver.github.io/settings/login?${document.URL}#Dieses+Feature+ist+aktuell+nicht+verfuegbar`)}
})}
catch {window.location.replace(`https://yeetserver.github.io/settings/login?${document.URL}#Du+bist+nicht+angemeldet`)}

</script>

</body>
</html>

